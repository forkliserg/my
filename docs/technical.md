# Техническая документация

## Архитектура генератора

Генератор конфигов построен с использованием модульной архитектуры:

- `config/` - настройки и конфигурационные параметры
- `fetchers/` - модули для загрузки конфигов из внешних источников
  - `fetcher.py` - базовый загрузчик конфигов
  - `yaml_converter.py` - конвертер YAML-конфигов в формат VPN URL
- `processors/` - основная обработка и фильтрация конфигов
  - `config_processor.py` - содержит всю основную логику обработки конфигов
- `utils/` - вспомогательные функции и утилиты
  - `file_utils.py` - файловые операции, фильтрация insecure конфигов, SNI/CIDR фильтрация
  - `logger.py` - логирование
  - `github_handler.py` - работа с GitHub API

### Основные компоненты

#### Main
- Содержит только main функцию, которая вызывает другие функции из других модулей
- Основная точка входа в приложение

#### Fetcher
- Загружает конфиги из внешних источников (обычные ссылки, base64-кодированные подписки, YAML-файлы, дополнительные источники для обхода)
- Обрабатывает ошибки и повторные попытки подключения
- Использует сессии с повторными попытками и адаптеры для устойчивости

#### Daily Repo Fetcher (новый компонент)
- Загружает конфиги из ежедневно обновляемого репозитория
- Использует формат именования файлов v2YYYYMMDD
- Реализует логику поиска конфигов с учетом часовых поясов (текущая дата, дата на день раньше, дата на день позже)
- Автоматически определяет и декодирует base64-кодированные конфиги
- Интегрирован с основным процессом через вызов в download_all_configs

#### Processor (config_processor.py)
- Загружает конфиги из всех источников, разделяя configs из EXTRA_URLS_FOR_BYPASS от основных configs
- Создает файл all.txt с уникальными конфигами из основных источников (URLS, URLS_BASE64, URLS_YAML)
- Создает файл all-secure.txt с безопасными конфигами из основных источников
- Создает файл bypass-all.txt с SNI/CIDR bypass конфигами: применяет SNI/CIDR фильтрацию к основным configs (с фильтрацией безопасности) и добавляет extra bypass configs (с фильтрацией безопасности, но без SNI/CIDR фильтрации)
- Создает файл bypass-unsecure-all.txt с SNI/CIDR bypass конфигами: применяет SNI/CIDR фильтрацию к основным configs (без фильтрации безопасности) и добавляет extra bypass configs (без SNI/CIDR и безопасности фильтрации)
- Разделяет большие bypass файлы на части по 300 конфигов
- Создает протокол-специфичные файлы в обеих версиях (secure и unsecure)
- Добавлена валидация VPN конфигов: теперь учитываются только строки, начинающиеся с поддерживаемого протокола (vless://, vmess://, trojan:// и др.) для предотвращения включения неподходящих строк в итоговые файлы

#### File Utils
- Содержит функцию `apply_sni_cidr_filter()` для унифицированной фильтрации по SNI и CIDR
- Функции дедупликации, фильтрации insecure конфигов и подготовки контента
- Функции извлечения хоста/порта и IP-адресов из конфигов

#### GitHub Handler
- Управляет загрузкой файлов в репозиторий GitHub
- Обрабатывает конфликты SHA и повторные попытки обновления
- Обновляет информацию о файлах

## Алгоритм работы

1. Загрузка конфигов из всех источников (обычные URL, base64-подписки, YAML-файлы) в один список и configs из EXTRA_URLS_FOR_BYPASS в отдельный список
2. Создание файла all.txt с уникальными конфигами из основного списка
3. Создание файла all-secure.txt с безопасными конфигами из основного списка
4. Создание безопасных обходных конфигов (папка bypass/): применение SNI/CIDR фильтрации к основному списку configs + добавление secure extra bypass configs (без SNI/CIDR фильтрации)
5. Разделение безопасных обходных конфигов на части по 300 configs
6. Создание небезопасных обходных конфигов (папка bypass-unsecure/): применение SNI/CIDR фильтрации к основному списку configs (без фильтрации безопасности) + добавление всех extra bypass configs (без SNI/CIDR и безопасности фильтрации)
7. Разделение небезопасных обходных конфигов на части по 300 configs
8. Создание протокол-специфичных файлов в обеих версиях (secure и unsecure) в папке split-by-protocols/
9. Загрузка всех файлов в репозиторий GitHub

## Оптимизации

- Параллельные загрузки для ускорения процесса
- Кэширование и проверка изменений для избежания лишних коммитов
- Разделение больших файлов (максимум 300 конфигов на файл) для мобильной производительности
- Умные регулярные выражения для быстрой фильтрации
- Фильтрация конфигов с insecure параметрами для повышения безопасности
- Поддержка обработки различных типов источников (обычные ссылки, base64-подписки, YAML-файлы)
- Четкое разделение ответственности между модулями для лучшей поддержки кода